---
# Gatekeeper ConstraintTemplate: Prevent Hardcoded Secrets in Environment Variables
#
# Purpose: Scan container environment variables for hardcoded secrets
# Aligned to: NIST IA-5(7) (No Embedded Secrets), Framework MI-001, MI-003
#
# Detection Patterns:
# - OpenAI API keys: sk-[a-zA-Z0-9]{32,}
# - AWS Access Keys: AKIA[0-9A-Z]{16}
# - GitHub Personal Access Tokens: ghp_[a-zA-Z0-9]{36}
# - Private Keys: -----BEGIN.*PRIVATE KEY-----
# - Generic base64 secrets: [A-Za-z0-9+/]{40,}==?
#
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8snosecretsinenv
  annotations:
    description: "Prevent hardcoded secrets in container environment variables"
    framework.ai/control-id: "MI-001, MI-003"
    nist.gov/control-id: "IA-5(7)"
    cis.benchmark: "5.4.1"
spec:
  crd:
    spec:
      names:
        kind: K8sNoSecretsInEnv
      validation:
        openAPIV3Schema:
          type: object
          properties:
            # Allow exemptions for specific containers (use sparingly)
            exemptContainers:
              type: array
              items:
                type: string
              description: "List of container names exempt from secret scanning"
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8snosecretsinenv

        import future.keywords.contains
        import future.keywords.if

        # Helper: Check if container is exempt
        is_exempt(container_name) if {
          exempt := input.parameters.exemptContainers[_]
          container_name == exempt
        }

        # Helper: Check for OpenAI API keys
        contains_openai_key(value) if {
          regex.match(`sk-[a-zA-Z0-9]{32,}`, value)
        }

        # Helper: Check for AWS access keys
        contains_aws_key(value) if {
          regex.match(`AKIA[0-9A-Z]{16}`, value)
        }

        # Helper: Check for GitHub tokens
        contains_github_token(value) if {
          regex.match(`ghp_[a-zA-Z0-9]{36}`, value)
        }

        # Helper: Check for GitHub fine-grained tokens
        contains_github_fine_grained_token(value) if {
          regex.match(`github_pat_[a-zA-Z0-9]{22}_[a-zA-Z0-9]{59}`, value)
        }

        # Helper: Check for private keys
        contains_private_key(value) if {
          regex.match(`-----BEGIN.*PRIVATE KEY-----`, value)
        }

        # Helper: Check for generic base64 secrets (40+ chars)
        contains_base64_secret(value) if {
          regex.match(`[A-Za-z0-9+/]{40,}==?`, value)
          # Exclude common non-secret base64 patterns
          not regex.match(`^(aHR0cHM6Ly98ZXhhbXBsZQ==)`, value)
        }

        # Helper: Check for Anthropic API keys
        contains_anthropic_key(value) if {
          regex.match(`sk-ant-[a-zA-Z0-9-]{95}`, value)
        }

        # Helper: Check for Google API keys
        contains_google_key(value) if {
          regex.match(`AIza[0-9A-Za-z\\-_]{35}`, value)
        }

        # Helper: Check for Slack tokens
        contains_slack_token(value) if {
          regex.match(`xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24,32}`, value)
        }

        # Helper: Check for JWT tokens
        contains_jwt(value) if {
          regex.match(`eyJ[a-zA-Z0-9_-]+\\.eyJ[a-zA-Z0-9_-]+\\.[a-zA-Z0-9_-]+`, value)
        }

        # VIOLATION 1: OpenAI key in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value  # Only check direct values, not valueFrom
          contains_openai_key(env.value)
          
          msg := sprintf("Container '%v' has OpenAI API key in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "openai_key"}
        }

        # VIOLATION 2: AWS key in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_aws_key(env.value)
          
          msg := sprintf("Container '%v' has AWS access key in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "aws_key"}
        }

        # VIOLATION 3: GitHub token in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          token_found := contains_github_token(env.value)
          
          msg := sprintf("Container '%v' has GitHub token in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "github_token"}
        }

        # VIOLATION 4: GitHub fine-grained token in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_github_fine_grained_token(env.value)
          
          msg := sprintf("Container '%v' has GitHub fine-grained token in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "github_fine_grained_token"}
        }

        # VIOLATION 5: Private key in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_private_key(env.value)
          
          msg := sprintf("Container '%v' has private key in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "private_key"}
        }

        # VIOLATION 6: Anthropic API key in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_anthropic_key(env.value)
          
          msg := sprintf("Container '%v' has Anthropic API key in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "anthropic_key"}
        }

        # VIOLATION 7: Google API key in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_google_key(env.value)
          
          msg := sprintf("Container '%v' has Google API key in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "google_key"}
        }

        # VIOLATION 8: Slack token in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_slack_token(env.value)
          
          msg := sprintf("Container '%v' has Slack token in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "slack_token"}
        }

        # VIOLATION 9: JWT token in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_jwt(env.value)
          
          msg := sprintf("Container '%v' has JWT token in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "jwt"}
        }

        # VIOLATION 10: Generic base64 secret in environment variable
        violation[{"msg": msg, "details": details}] {
          container := input.review.object.spec.containers[_]
          not is_exempt(container.name)
          
          env := container.env[_]
          env.value
          contains_base64_secret(env.value)
          
          # Don't double-report if already caught by specific patterns
          not contains_openai_key(env.value)
          not contains_aws_key(env.value)
          not contains_github_token(env.value)
          not contains_private_key(env.value)
          
          msg := sprintf("Container '%v' has potential base64-encoded secret in environment variable '%v'", [container.name, env.name])
          details := {"container": container.name, "env_var": env.name, "secret_type": "base64_secret"}
        }
