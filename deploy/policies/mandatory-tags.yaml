---
# Mandatory Cost Attribution Tags Policy
#
# Purpose: Enforce required cost tags on all resources
# Guarantees: 100% cost attribution by blocking untagged resources

apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: mandatory-cost-tags
  annotations:
    policies.kyverno.io/title: Mandatory Cost Attribution Tags
    policies.kyverno.io/category: Cost Management
    policies.kyverno.io/severity: high
    policies.kyverno.io/description: >-
      Enforces mandatory cost attribution tags (cost-center, agent-id) on all resources.
      Blocks resource creation if required tags are missing.
      Guarantees 100% cost attribution completeness.
spec:
  validationFailureAction: enforce
  background: true
  rules:
    - name: require-cost-center-tag
      match:
        any:
        - resources:
            kinds:
              - Pod
              - PersistentVolumeClaim
              - Service
              - Deployment
              - StatefulSet
      validate:
        message: "Resource must have 'cost-center' label matching pattern CC-####"
        pattern:
          metadata:
            labels:
              cost-center: "CC-????"
    
    - name: require-agent-id-tag
      match:
        any:
        - resources:
            kinds:
              - Pod
              - PersistentVolumeClaim
              - Service
              - Deployment
              - StatefulSet
      validate:
        message: "Resource must have 'agent-id' label"
        pattern:
          metadata:
            labels:
              agent-id: "?*"
